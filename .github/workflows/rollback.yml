name: Reusable Rollback

on:
  workflow_call:
    inputs:
      environment:
        description: 'Environment to rollback'
        required: true
        type: string
      acr-name:
        description: 'Azure Container Registry name'
        required: true
        type: string
      image-name:
        description: 'Docker image name'
        required: true
        type: string
      image-tag:
        description: 'Version to rollback to'
        required: true
        type: string
      reason:
        description: 'Reason for rollback'
        required: true
        type: string
      gitops-repo:
        description: 'GitOps repository (org/repo)'
        required: true
        type: string
      gitops-path:
        description: 'Path in GitOps repo'
        required: true
        type: string
      base-image-name:
        description: 'Base image name in kustomization'
        required: true
        type: string
      runs-on:
        description: 'Runner to use'
        required: false
        type: string
        default: 'ubuntu-latest'
      argocd-server:
        description: 'ArgoCD server URL'
        required: false
        type: string
        default: ''
      argocd-app-name:
        description: 'ArgoCD application name'
        required: false
        type: string
        default: ''
      health-check-url:
        description: 'Health check URL'
        required: false
        type: string
        default: ''
    secrets:
      AZURE_CLIENT_ID:
        required: true
      AZURE_TENANT_ID:
        required: true
      AZURE_SUBSCRIPTION_ID:
        required: true
      GITOPS_PAT:
        required: true
      ARGOCD_USERNAME:
        required: false
      ARGOCD_PASSWORD:
        required: false

permissions:
  id-token: write
  contents: read

jobs:
  # ================================
  # JOB 1: Validate
  # ================================
  validate:
    name: Validate Rollback
    runs-on: ${{ inputs.runs-on }}
    environment: ${{ inputs.environment }}
    
    steps:
      - name: Log rollback request
        run: |
          echo "========================================="
          echo "ROLLBACK REQUEST"
          echo "========================================="
          echo "Environment: ${{ inputs.environment }}"
          echo "Version: ${{ inputs.image-tag }}"
          echo "Reason: ${{ inputs.reason }}"
          echo "Initiated by: ${{ github.actor }}"
          echo "Time: $(date -u)"
          echo "========================================="

      - name: Login to Azure
        uses: azure/login@v2
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

      - name: Login to ACR
        run: az acr login --name ${{ inputs.acr-name }}

      - name: Verify image exists
        run: |
          echo "Checking if image exists in ACR..."
          
          if az acr repository show-tags \
            --name ${{ inputs.acr-name }} \
            --repository ${{ inputs.image-name }} \
            --query "[?@=='${{ inputs.image-tag }}']" \
            -o tsv | grep -q "${{ inputs.image-tag }}"; then
            echo "✅ Image tag '${{ inputs.image-tag }}' found in ACR"
          else
            echo "❌ ERROR: Image tag '${{ inputs.image-tag }}' not found in ACR!"
            echo ""
            echo "Available tags:"
            az acr repository show-tags --name ${{ inputs.acr-name }} --repository ${{ inputs.image-name }} -o table
            exit 1
          fi

  # ================================
  # JOB 2: Update GitOps
  # ================================
  update-gitops:
    name: Update GitOps Repository
    runs-on: ${{ inputs.runs-on }}
    needs: validate
    environment: ${{ inputs.environment }}
    
    steps:
      - name: Checkout GitOps repo
        uses: actions/checkout@v4
        with:
          repository: ${{ inputs.gitops-repo }}
          token: ${{ secrets.GITOPS_PAT }}
          path: gitops

      - name: Verify Kustomize installed
        run: kustomize version

      - name: Update image tag
        run: |
          cd gitops/${{ inputs.gitops-path }}
          
          NEW_IMAGE="${{ inputs.acr-name }}.azurecr.io/${{ inputs.image-name }}:${{ inputs.image-tag }}"
          
          kustomize edit set image ${{ inputs.base-image-name }}=${NEW_IMAGE}
          
          echo "========================================="
          echo "Rolling back ${{ inputs.environment }} to: ${{ inputs.image-tag }}"
          echo "========================================="
          cat kustomization.yaml

      - name: Commit and push
        run: |
          cd gitops
          git config user.name "GitHub Actions"
          git config user.email "actions@github.com"
          git add .
          
          if git diff --staged --quiet; then
            echo "No changes to commit - already at version ${{ inputs.image-tag }}"
          else
            git commit -m "rollback(${{ inputs.environment }}): revert to ${{ inputs.image-tag }} - ${{ inputs.reason }}"
            git push
          fi

  # ================================
  # JOB 3: Sync ArgoCD
  # ================================
  sync-argocd:
    name: Sync ArgoCD
    runs-on: ${{ inputs.runs-on }}
    needs: update-gitops
    if: ${{ inputs.argocd-server != '' && inputs.argocd-app-name != '' }}
    environment: ${{ inputs.environment }}
    
    steps:
      - name: Verify ArgoCD CLI installed
        run: argocd version --client

      - name: Login to ArgoCD
        run: |
          argocd login ${{ inputs.argocd-server }} \
            --username ${{ secrets.ARGOCD_USERNAME }} \
            --password ${{ secrets.ARGOCD_PASSWORD }} \
            --grpc-web

      - name: Sync Application
        run: |
          echo "Triggering sync for ${{ inputs.argocd-app-name }}..."
          argocd app sync ${{ inputs.argocd-app-name }} --grpc-web
          
      - name: Wait for Sync
        run: |
          echo "Waiting for rollback to complete..."
          argocd app wait ${{ inputs.argocd-app-name }} \
            --timeout 300 \
            --health \
            --grpc-web
          echo "✅ Rollback sync completed!"

  # ================================
  # JOB 4: Smoke Test
  # ================================
  smoke-test:
    name: Smoke Test
    runs-on: ${{ inputs.runs-on }}
    needs: [update-gitops, sync-argocd]
    if: always() && inputs.health-check-url != '' && (needs.sync-argocd.result == 'success' || needs.sync-argocd.result == 'skipped')
    environment: ${{ inputs.environment }}
    
    steps:
      - name: Run Smoke Test
        run: |
          echo "Running smoke test..."
          sleep 10
          
          MAX_RETRIES=5
          RETRY_COUNT=0
          
          while [ $RETRY_COUNT -lt $MAX_RETRIES ]; do
            HTTP_STATUS=$(curl -s -o /dev/null -w "%{http_code}" "${{ inputs.health-check-url }}" || echo "000")
            
            if [ "$HTTP_STATUS" == "200" ]; then
              echo "========================================="
              echo "✅ SMOKE TEST PASSED!"
              echo "========================================="
              exit 0
            fi
            
            RETRY_COUNT=$((RETRY_COUNT + 1))
            echo "Attempt $RETRY_COUNT/$MAX_RETRIES - Status: $HTTP_STATUS"
            sleep 10
          done
          
          echo "❌ SMOKE TEST FAILED!"
          exit 1

  # ================================
  # JOB 5: Rollback Summary
  # ================================
  summary:
    name: Rollback Summary
    runs-on: ${{ inputs.runs-on }}
    needs: [validate, update-gitops, sync-argocd, smoke-test]
    if: always()
    
    steps:
      - name: Rollback Summary
        run: |
          echo "========================================="
          echo "ROLLBACK SUMMARY"
          echo "========================================="
          echo "Environment: ${{ inputs.environment }}"
          echo "Rolled back to: ${{ inputs.image-tag }}"
          echo "Reason: ${{ inputs.reason }}"
          echo "Initiated by: ${{ github.actor }}"
          echo "Time: $(date -u)"
          echo ""
          echo "Results:"
          echo "  Validation: ${{ needs.validate.result }}"
          echo "  GitOps Update: ${{ needs.update-gitops.result }}"
          echo "  ArgoCD Sync: ${{ needs.sync-argocd.result }}"
          echo "  Smoke Test: ${{ needs.smoke-test.result }}"
          echo "========================================="
